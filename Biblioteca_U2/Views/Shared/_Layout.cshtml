<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - Biblioteca UPT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'sans': ['Segoe UI', 'Poppins', 'sans-serif'] },
                    colors: { 'purple-gradient-start': '#667eea', 'purple-gradient-end': '#764ba2' }
                }
            }
        }
    </script>
    <style>
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        header {
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
        }
        main {
            padding-top: 2rem;
        }
    </style>
</head>
<body>
    @if (Session["UserName"] != null)
    {
        var esAdmin = Session["UserRole"]?.ToString() == "admin";
        var controller = ViewContext.RouteData.Values["controller"]?.ToString();
        var action = ViewContext.RouteData.Values["action"]?.ToString();
        
        <header class="bg-white/90 shadow-md border-b-4 border-gradient-to-r from-purple-gradient-start to-purple-gradient-end">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-8">
                        <div class="flex items-center">
                            <i class="fas @(esAdmin ? "fa-user-shield" : "fa-book-open") text-3xl text-purple-600 mr-3"></i>
                            <h1 class="text-2xl font-bold text-gray-800">@(esAdmin ? "Panel Administrador" : "Biblioteca UPT")</h1>
                        </div>
                        <nav class="hidden md:flex space-x-6">
                            @if (esAdmin)
                            {
                                <a href="@Url.Action("Dashboard","Admin")" class="text-gray-700 hover:text-purple-600 font-medium transition @(controller == "Admin" && action == "Dashboard" ? "text-purple-600 font-bold" : "")">
                                    <i class="fas fa-chart-line mr-1"></i>Dashboard
                                </a>
                                <a href="@Url.Action("Registrar","Libros")" class="text-gray-700 hover:text-purple-600 font-medium transition @(controller == "Libros" && action == "Registrar" ? "text-purple-600 font-bold" : "")">
                                    <i class="fas fa-plus-circle mr-1"></i>Registrar Libro
                                </a>
                                <a href="@Url.Action("SolicitudesPendientes","Prestamos")" class="text-gray-700 hover:text-purple-600 font-medium transition @(controller == "Prestamos" && action == "SolicitudesPendientes" ? "text-purple-600 font-bold" : "")">
                                    <i class="fas fa-clipboard-list mr-1"></i>Solicitudes
                                </a>
                                <a href="@Url.Action("PrestamosActivos","Prestamos")" class="text-gray-700 hover:text-purple-600 font-medium transition @(controller == "Prestamos" && action == "PrestamosActivos" ? "text-purple-600 font-bold" : "")">
                                    <i class="fas fa-book-open mr-1"></i>Préstamos
                                </a>
                                <a href="@Url.Action("ReservasActivas","Reservas")" class="text-gray-700 hover:text-purple-600 font-medium transition @(controller == "Reservas" && action == "ReservasActivas" ? "text-purple-600 font-bold" : "")">
                                    <i class="fas fa-clock mr-1"></i>Reservas
                                </a>
                            }
                            else
                            {
                                <a href="@Url.Action("Index","Home")" class="text-gray-700 hover:text-purple-600 font-medium transition @(controller == "Home" && action == "Index" ? "text-purple-600 font-bold" : "")">
                                    <i class="fas fa-home mr-1"></i>Inicio
                                </a>
                                <a href="@Url.Action("Catalogo","Libros")" class="text-gray-700 hover:text-purple-600 font-medium transition @(controller == "Libros" && action == "Catalogo" ? "text-purple-600 font-bold" : "")">
                                    <i class="fas fa-book mr-1"></i>Catálogo
                                </a>
                                <a href="@Url.Action("MisPrestamos","Prestamos")" class="text-gray-700 hover:text-purple-600 font-medium transition @(controller == "Prestamos" && action == "MisPrestamos" ? "text-purple-600 font-bold" : "")">
                                    <i class="fas fa-bookmark mr-1"></i>Mis Préstamos
                                </a>
                                <a href="@Url.Action("MisReservas","Reservas")" class="text-gray-700 hover:text-purple-600 font-medium transition @(controller == "Reservas" && action == "MisReservas" ? "text-purple-600 font-bold" : "")">
                                    <i class="fas fa-clock mr-1"></i>Reservas
                                </a>
                                <a href="@Url.Action("HistorialCreditos","Prestamos")" class="text-gray-700 hover:text-purple-600 font-medium transition @(controller == "Prestamos" && action == "HistorialCreditos" ? "text-purple-600 font-bold" : "")">
                                    <i class="fas fa-coins mr-1"></i>Créditos
                                </a>
                                <a href="@Url.Action("Ranking","Calificaciones")" class="text-gray-700 hover:text-purple-600 font-medium transition @(controller == "Calificaciones" && action == "Ranking" ? "text-purple-600 font-bold" : "")">
                                    <i class="fas fa-trophy mr-1"></i>Ranking
                                </a>
                                <a href="@Url.Action("ChatBotVirtual","ChatBot")" class="text-gray-700 hover:text-purple-600 font-medium transition @(controller == "ChatBot" && action == "ChatBotVirtual" ? "text-purple-600 font-bold" : "")">
                                    <i class="fas fa-robot mr-1"></i>Asistente
                                </a>
                            }
                        </nav>
                    </div>
                    <div class="flex items-center space-x-4">
                        @{
                            var userName = Session["UserName"]?.ToString();
                            if (!string.IsNullOrEmpty(userName))
                            {
                                if (!esAdmin)
                                {
                                    <a href="@Url.Action("MiPerfil","Calificaciones")" 
                                       class="flex items-center gap-2 text-gray-700 hover:text-purple-600 font-medium transition @(controller == "Calificaciones" && action == "MiPerfil" ? "text-purple-600 font-bold" : "")">
                                        <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">
                                            @userName.Substring(0, 1).ToUpper()
                                        </div>
                                        <span>@userName</span>
                                    </a>
                                }
                                else
                                {
                                    <span class="text-gray-700 font-medium flex items-center gap-2">
                                        <i class="fas fa-user-shield text-purple-600"></i>
                                        @userName
                                    </span>
                                }
                            }
                        }
                        <a href="@Url.Action("Logout","Account")"
                           class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-4 py-2 rounded-lg font-semibold hover:from-purple-700 hover:to-purple-800 transition duration-300">
                            <i class="fas fa-sign-out-alt mr-2"></i>Salir
                        </a>
                    </div>
                </div>
            </div>
        </header>
    }

    @RenderBody()

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 🤖 Asistente Virtual (solo estudiantes) -->
    @if (Session["Rol"] != null && Session["Rol"].ToString() == "Estudiante")
    {
        <div id="asistente-barra">
            <div id="asistente-avatar">
                <img src="~/Content/img/artificial.gif" alt="Asistente" />
            </div>
            <div id="asistente-texto">💬 ¡Hola! Soy tu asistente virtual. ¿Tienes alguna duda?</div>
        </div>

        <audio id="vozLucia" src="~/Content/audio/voz.wav" preload="auto"></audio>

        <style>
            #asistente-barra {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(90deg, #667eea, #764ba2);
                color: white;
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: flex-start;
                padding: 10px 20px;
                box-shadow: 0 -3px 10px rgba(0,0,0,0.3);
                z-index: 10000;
            }

            #asistente-avatar {
                margin-right: 15px;
                animation: float 3s ease-in-out infinite;
            }

                #asistente-avatar img {
                    width: 60px;
                    height: 60px;
                    border-radius: 50%;
                }

            #asistente-texto {
                flex: 1;
            }

            @@keyframes float {
                0%, 100% {
                    transform: translateY(0px);
                }

                50% {
                    transform: translateY(-5px);
                }
            }
        </style>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const audio = document.getElementById("vozLucia");
                const mensaje = "Hola, soy tu asistente virtual. Estoy aquí para ayudarte en cualquier duda que tengas.";

                // Reproduce la voz grabada si el usuario permite sonido
                const reproducir = () => {
                    audio.play().catch(() => {
                        document.addEventListener("click", () => {
                            if (audio.paused) audio.play();
                        }, { once: true });
                    });
                };
                reproducir();

                // También puedes usar voz sintética de respaldo
                if ('speechSynthesis' in window) {
                    const utter = new SpeechSynthesisUtterance(mensaje);
                    utter.lang = 'es-ES';
                    utter.rate = 1;
                    utter.pitch = 1.1;
                    speechSynthesis.speak(utter);
                }
            });
        </script>
    }
    </body>
</html>